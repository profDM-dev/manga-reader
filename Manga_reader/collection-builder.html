<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Collection Builder - YoruManga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        .font-japanese { font-family: 'Noto Sans JP', sans-serif; }
        .font-main { font-family: 'Poppins', sans-serif; }
        .log-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .manga-card {
            transition: all 0.3s ease;
        }
        .manga-card:hover {
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 font-main min-h-screen flex items-center justify-center p-8">
    
    <div class="max-w-4xl w-full">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="text-6xl font-black text-red-500 font-japanese mb-2">Â§ú</div>
            <h1 class="text-4xl font-bold text-white font-japanese mb-2">Manga Collection Builder</h1>
            <p class="text-gray-400">Generate 800-1000 manga entries with real MangaDex data</p>
        </div>

        <!-- Control Panel -->
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl mb-6">
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Target Count</label>
                    <input 
                        type="number" 
                        id="targetCount" 
                        value="1000" 
                        min="100" 
                        max="2000" 
                        step="100"
                        class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg border-2 border-gray-600 focus:border-red-500 outline-none"
                    />
                </div>
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Filename</label>
                    <input 
                        type="text" 
                        id="filename" 
                        value="manga-collection.json"
                        class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg border-2 border-gray-600 focus:border-red-500 outline-none"
                    />
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>Progress</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-red-500 to-red-600 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4">
                <button 
                    id="buildBtn"
                    onclick="startBuild()" 
                    class="flex-1 px-6 py-4 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-lg transition-colors"
                >
                    üöÄ Build Collection
                </button>
                <button 
                    id="loadSampleBtn"
                    onclick="loadSampleData()" 
                    class="px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-colors"
                >
                    üìö Load 300 Samples
                </button>
                <button 
                    id="exportBtn"
                    onclick="exportCollection()" 
                    class="px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    üíæ Export JSON
                </button>
                <button 
                    onclick="clearCollection()" 
                    class="px-6 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold transition-colors"
                >
                    üóëÔ∏è Clear
                </button>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="bg-gray-800 rounded-2xl p-4 shadow-2xl mb-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-white">View Mode</h3>
                <div class="flex gap-2">
                    <button onclick="switchView('cards')" id="viewCards" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold transition-colors">
                        Cards
                    </button>
                    <button onclick="switchView('console')" id="viewConsole" class="px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold transition-colors">
                        Console
                    </button>
                </div>
            </div>
        </div>

        <!-- Manga Cards Display -->
        <div id="cardsView" class="bg-gray-800 rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Manga Collection</h3>
                <input 
                    type="text" 
                    id="searchCards" 
                    placeholder="Search manga..." 
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg border-2 border-gray-600 focus:border-red-500 outline-none"
                    oninput="filterCards()"
                />
            </div>
            <div id="mangaCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-h-[600px] overflow-y-auto p-2">
                <div class="col-span-full text-center text-gray-400 py-20">
                    No manga in collection yet. Click "Build Collection" to start!
                </div>
            </div>
        </div>

        <!-- Live Console Log -->
        <div id="consoleView" class="bg-gray-800 rounded-2xl p-6 shadow-2xl hidden">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></span>
                Console Log
            </h3>
            <div id="consoleLog" class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm text-green-400">
                <div class="text-gray-500">Ready to build collection...</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4 mt-6">
            <div class="bg-gray-800 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-red-500" id="statTotal">0</div>
                <div class="text-gray-400 text-sm">Total Manga</div>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-blue-500" id="statTime">0s</div>
                <div class="text-gray-400 text-sm">Time Elapsed</div>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-green-500" id="statRate">0/s</div>
                <div class="text-gray-400 text-sm">Fetch Rate</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/ui.js"></script>
    <script src="js/manga-collection.js"></script>
    <script src="js/manga-data.js"></script>
    
    <script>
        let startTime;
        let updateInterval;
        let currentView = 'cards';

        function switchView(view) {
            currentView = view;
            
            // Update buttons
            document.getElementById('viewCards').className = view === 'cards' 
                ? 'px-4 py-2 bg-red-500 text-white rounded-lg font-semibold transition-colors'
                : 'px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold transition-colors';
            
            document.getElementById('viewConsole').className = view === 'console' 
                ? 'px-4 py-2 bg-red-500 text-white rounded-lg font-semibold transition-colors'
                : 'px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold transition-colors';
            
            // Toggle views
            if (view === 'cards') {
                document.getElementById('cardsView').classList.remove('hidden');
                document.getElementById('consoleView').classList.add('hidden');
            } else {
                document.getElementById('cardsView').classList.add('hidden');
                document.getElementById('consoleView').classList.remove('hidden');
            }
        }

        function renderMangaCards(filter = '') {
            const grid = document.getElementById('mangaCards');
            const collection = window.MangaCollection.collection;
            
            if (collection.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-20">No manga in collection yet. Click "Build Collection" to start!</div>';
                return;
            }
            
            const filtered = filter 
                ? collection.filter(m => m.title.toLowerCase().includes(filter.toLowerCase()))
                : collection;
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-20">No manga found matching your search.</div>';
                return;
            }
            
            grid.innerHTML = '';
            
            filtered.forEach(manga => {
                const card = document.createElement('a');
                card.href = manga.url;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.className = 'group block bg-white dark:bg-gray-700 rounded-xl shadow-md overflow-hidden hover:shadow-xl hover:scale-105 transition-all';
                
                card.innerHTML = `
                    <img src="${manga.cover}" 
                         alt="${manga.title}"
                         class="w-full h-60 object-cover group-hover:opacity-90 transition"
                         onerror="this.src='assets/placeholder.svg'"
                         loading="lazy">
                    
                    <div class="p-3">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white group-hover:text-red-500 transition line-clamp-2">
                            ${manga.title}
                        </h3>
                        ${manga.genres.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${manga.genres.slice(0, 2).map(g => `
                                    <span class="text-xs px-2 py-0.5 bg-red-500 text-white rounded-full">${g}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function showError() {
            document.getElementById('mangaCards').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-center col-span-full">
                    <svg class="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Oops! Something went wrong</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Failed to load manga. Please check your connection and try again.</p>
                    <button onclick="startBuild()" class="mt-4 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Try Again
                    </button>
                </div>
            `;
        }

        function loadSampleData() {
            if (!window.MANGA_DATA) {
                log('Sample data not loaded!', 'error');
                return;
            }
            
            // Clear existing collection
            window.MangaCollection.collection = [];
            
            // Load sample data
            window.MANGA_DATA.forEach(manga => {
                window.MangaCollection.collection.push({
                    id: manga.id,
                    title: manga.title,
                    cover: manga.cover,
                    url: manga.url,
                    altTitles: [],
                    genres: [],
                    status: 'unknown',
                    year: null,
                    description: 'Sample manga entry with real cover and URL.'
                });
            });
            
            const count = window.MangaCollection.collection.length;
            updateProgress(count, count);
            document.getElementById('statTotal').textContent = count;
            document.getElementById('exportBtn').disabled = false;
            
            renderMangaCards();
            log(`‚úÖ Loaded ${count} sample manga with covers and URLs!`, 'success');
        }

        function filterCards() {
            const searchTerm = document.getElementById('searchCards').value;
            renderMangaCards(searchTerm);
        }

        function log(message, type = 'info') {
            const consoleLog = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                success: 'text-blue-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[type]}`;
            entry.textContent = `[${timestamp}] ${message}`;
            consoleLog.appendChild(entry);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function updateProgress(current, target) {
            const percent = (current / target) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${current} / ${target}`;
            document.getElementById('statTotal').textContent = current;
            
            // Update cards display in real-time
            if (currentView === 'cards') {
                renderMangaCards();
            }
        }

        function updateStats() {
            if (!startTime) return;
            
            const elapsed = (Date.now() - startTime) / 1000;
            const total = window.MangaCollection.collection.length;
            const rate = (total / elapsed).toFixed(1);
            
            document.getElementById('statTime').textContent = `${Math.floor(elapsed)}s`;
            document.getElementById('statRate').textContent = `${rate}/s`;
        }

        async function startBuild() {
            const targetCount = parseInt(document.getElementById('targetCount').value);
            const buildBtn = document.getElementById('buildBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            buildBtn.disabled = true;
            buildBtn.textContent = '‚è≥ Building...';
            exportBtn.disabled = true;
            
            window.MangaCollection.collection = [];
            startTime = Date.now();
            
            log(`Starting collection build: ${targetCount} manga`, 'success');
            log('Fetching from MangaDex API...', 'info');
            
            // Start stats update
            updateInterval = setInterval(updateStats, 100);
            
            const batchSize = 100;
            const batches = Math.ceil(targetCount / batchSize);
            
            for (let i = 0; i < batches; i++) {
                const offset = i * batchSize;
                
                try {
                    await window.MangaCollection.fetchBatch(batchSize, offset);
                    const current = window.MangaCollection.collection.length;
                    updateProgress(current, targetCount);
                    log(`Batch ${i + 1}/${batches} complete: ${current} manga fetched`, 'info');
                    
                    // Rate limiting
                    if (i < batches - 1) {
                        await new Promise(resolve => setTimeout(resolve, 250));
                    }
                } catch (error) {
                    log(`Error in batch ${i + 1}: ${error.message}`, 'error');
                }
            }
            
            clearInterval(updateInterval);
            updateStats();
            
            const final = window.MangaCollection.collection.length;
            log(`‚úÖ Build complete! ${final} manga collected`, 'success');
            log('Saving to localStorage...', 'info');
            
            window.MangaCollection.saveToStorage();
            log('Saved successfully!', 'success');
            
            buildBtn.disabled = false;
            buildBtn.textContent = 'üöÄ Build Collection';
            exportBtn.disabled = false;
            
            // Render final cards
            renderMangaCards();
        }

        function exportCollection() {
            if (window.MangaCollection.collection.length === 0) {
                log('No collection to export!', 'error');
                return;
            }
            
            const filename = document.getElementById('filename').value;
            window.MangaCollection.downloadJSON(filename);
            log(`üì• Exported ${window.MangaCollection.collection.length} manga to ${filename}`, 'success');
        }

        function clearCollection() {
            window.MangaCollection.collection = [];
            localStorage.removeItem('mangaCollection');
            updateProgress(0, 0);
            document.getElementById('statTotal').textContent = '0';
            document.getElementById('statTime').textContent = '0s';
            document.getElementById('statRate').textContent = '0/s';
            document.getElementById('consoleLog').innerHTML = '<div class="text-gray-500">Ready to build collection...</div>';
            document.getElementById('exportBtn').disabled = true;
            renderMangaCards();
            log('Collection cleared', 'warning');
        }

        // Try to load existing collection on page load
        window.addEventListener('load', () => {
            if (window.MangaCollection.loadFromStorage()) {
                const count = window.MangaCollection.collection.length;
                log(`Loaded ${count} manga from localStorage`, 'success');
                updateProgress(count, count);
                document.getElementById('exportBtn').disabled = false;
                renderMangaCards();
            }
        });
    </script>
</body>
</html>
